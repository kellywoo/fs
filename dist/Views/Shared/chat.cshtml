@using mtopt.logic;
@using mtopt.model.EntitySales;
@{
    Layout = null;
    member SendMember = ViewBag.SendMember;
    member CollMember = ViewBag.CollMember;
}
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="x-rim-auto-match" content="none">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>与@(CollMember.username)聊天</title>
    <link href="@(Basis.GetCDN())/iconfont/iconfont.css" rel="stylesheet" />
    <link href="@(Basis.GetCDN())/mui.min/mui.min.css" rel="stylesheet" />
    <link href="@(Basis.GetCDN())/forms.min/forms.min.css" rel="stylesheet" />

    <style type="text/css">
        body{max-width:720px;margin:0 auto;background:#f1f1f1;color:#333;}
        h5{margin:0}img{max-width:100%;vertical-align:middle;cursor:pointer;}input{outline:0;}
        @@keyframes msleft{  0%{transform: translateX(-100px);opacity:0.1}100%{transform: translateX(0);opacity:1}  } 
        @@keyframes msright{  0%{transform: translateX(100px);opacity:0.1}100%{transform: translateX(0);opacity:1}  }  
        @@keyframes mstop{  0%{transform: translateY(100px);opacity:0.1}100%{transform: translateY(0);opacity:1}  }  
        @@keyframes zoom{  0%{transform:scale(0.1);opacity:0.1}100%{transform: scale(1);opacity:1}  }  
        .big-img{position:fixed;width:100%;height:auto;left:0px;animation: zoom 0.5s;top:0em;background:rgba(0,0,0,0.5);z-index:9999;text-align:center;overflow:auto;display:none;}
        .big-img span{position:absolute;right:0.5em;top:0.3em;font-size:2em;color:#fff !important;cursor:pointer;}
        .big-img img{width:auto !important;}
        .mui-content{animation: pageinit 1s;width:100%;padding-bottom:4em;}
        .face-img{width:1.5em;margin-left:0.1em}
        #footer table{height:2em;margin-top:0.5em;width:100%;z-index:9999;}
        #footer span{margin-left:0.3em;margin-top:0.15em;font-size:2em;color:#bbb;cursor:pointer;}
        #sendbtn{margin:0px;width:4em;height:2.2em;font-size:0.95em;color:#fff;line-height:1em;text-align:center;background-color:#ddd;border-radius:0.3em;margin-left:0.8em;margin-right:0.5em;border:0px none;}
        #sendtext{margin:0px;margin-left:0.5em;border-radius:0.3em;padding:0.5em;width:99%;height:2em; border:1px solid #ddd;}
        .message{padding:1em 0.5em;}
        .time{font-size:0.7em;color:#999;margin-bottom:0.8em;text-align:center;}
        .msg:after,.send:after,.show:after{content:"";clear:both;display:table}
        .msg>img{width:3em;float:left;animation: zoom 0.5s;}
        .msg>p{float:left;margin:0.5em;padding:0.8em;margin-top:0px;background:#fff;font-size:1em;position:relative;border-radius:0.5em;max-width:18em;box-sizing:border-box;}
        .show p{animation: msright 0.5s;}
        .send p{animation: msleft 0.5s;}
        .msg_input{position:absolute;background:url(/images/chat/msg-input.png) no-repeat;background-size:.31rem auto;width:.31rem;height:.51rem;left:-.31rem;top:.25rem}
        .show .msg,.show .msg img,.show .msg p{float:right}
        .show .msg p img{float:none}
        .show .msg_input{left:auto;right:-.11rem;transform:rotate(180deg);-ms-transform:rotate(180deg);-moz-transform:rotate(180deg);-webkit-transform:rotate(180deg);-o-transform:rotate(180deg)}
        .send,.show{padding-bottom:0.5em}
        .face-block{position:fixed;margin:0px;padding:0.1em;background:#fff;bottom:3.1em;width:15.55em;height:8.2em;border:1px solid #ccc;animation: mstop 0.5s;z-index:0;display:none;border-bottom:1px solid #f5f5f5;}
        .face-block img{width:1.8em;margin:0.05em;padding:0px;margin-left:0.05em !important;margin-right:0.05em !important;border:1px solid #fff;}
        .face-block img:hover,.face-block img:active{border:1px solid #ffaa00;cursor:pointer;}
    </style>
    <script type="text/javascript" src="@(Basis.GetCDN())/mtopt-3.0-min.js"></script>
    <script type="text/javascript" src="@(Basis.GetCDN())/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="@(Basis.GetCDN())/mui.min/mui.min.js"></script>
    <script type="text/javascript" src="@(Basis.GetCDN())/forms.min/forms.min.js"></script>
    <script type="text/javascript" src="~/Scripts/lrz.all.bundle.js"></script>
</head>
<body>
    <nav class="mui-bar mui-bar-nav">
        <a href="javascript:history.back()" class="mui-action-back mui-icon mui-icon-jiantou-copy mui-pull-left" style="color:#007aff;font-weight:bold;"></a>
        <h1 class="mui-title">@(CollMember.username)</h1>
    </nav>
    <div class="big-img"><img src="" /><span class="mui-icon mui-icon-shanchu2" onclick="$(this.parentNode).hide()"></span></div>
    <div id="wrapper" class="mui-content mui-scroll-wrapper mui-tap-bind">
        <div class="mui-scroll">
            <div class="message">
            </div>
        </div>
    </div>
    <nav id="footer" class="mui-bar mui-bar-tab mui-tap-bind">
        <div class="face-block">
            <img onclick="pck.face('01')" src="~/Images/Chat/i_f01.gif" />
            <img onclick="pck.face('02')" src="~/Images/Chat/i_f02.gif" />
            <img onclick="pck.face('03')" src="~/Images/Chat/i_f03.gif" />
            <img onclick="pck.face('04')" src="~/Images/Chat/i_f04.gif" />
            <img onclick="pck.face('05')" src="~/Images/Chat/i_f05.gif" />
            <img onclick="pck.face('06')" src="~/Images/Chat/i_f06.gif" />
            <img onclick="pck.face('07')" src="~/Images/Chat/i_f07.gif" />
            <img onclick="pck.face('08')" src="~/Images/Chat/i_f08.gif" />
            <img onclick="pck.face('09')" src="~/Images/Chat/i_f09.gif" />
            <img onclick="pck.face('10')" src="~/Images/Chat/i_f10.gif" />
            <img onclick="pck.face('11')" src="~/Images/Chat/i_f11.gif" />
            <img onclick="pck.face('12')" src="~/Images/Chat/i_f12.gif" />
            <img onclick="pck.face('13')" src="~/Images/Chat/i_f13.gif" />
            <img onclick="pck.face('14')" src="~/Images/Chat/i_f14.gif" />
            <img onclick="pck.face('15')" src="~/Images/Chat/i_f15.gif" />
            <img onclick="pck.face('16')" src="~/Images/Chat/i_f16.gif" />
            <img onclick="pck.face('17')" src="~/Images/Chat/i_f17.gif" />
            <img onclick="pck.face('18')" src="~/Images/Chat/i_f18.gif" />
            <img onclick="pck.face('19')" src="~/Images/Chat/i_f19.gif" />
            <img onclick="pck.face('20')" src="~/Images/Chat/i_f20.gif" />
            <img onclick="pck.face('21')" src="~/Images/Chat/i_f21.gif" />
            <img onclick="pck.face('22')" src="~/Images/Chat/i_f22.gif" />
            <img onclick="pck.face('23')" src="~/Images/Chat/i_f23.gif" />
            <img onclick="pck.face('24')" src="~/Images/Chat/i_f24.gif" />
            <img onclick="pck.face('25')" src="~/Images/Chat/i_f25.gif" />
            <img onclick="pck.face('26')" src="~/Images/Chat/i_f26.gif" />
            <img onclick="pck.face('27')" src="~/Images/Chat/i_f27.gif" />
            <img onclick="pck.face('28')" src="~/Images/Chat/i_f28.gif" />
        </div>
        <table cellpadding="0" cellspacing="0">
            <tr>
                <td style="width:2.5em" valign="top">
                    <div class="wrap">
                        <div id="idcardz_pre">
                            <span id="idcardz_img" class="mui-icon mui-icon-tupian" onclick="pck.inputopen('#idcardz');"></span>
                        </div>
                        <input type="file" onchange="pck.previewImage(this)" style="display: none;" id="idcardz">
                    </div>
                </td>
                <td style="width:2.5em" valign="top">
                    <span class="mui-icon mui-icon-xiaoxizhongxin" onclick="pck.showface()"></span>
                </td>
                <td valign="top">
                    <input id="sendtext" type="text" />
                </td>
                <td style="width:5em;text-align:right;" valign="top">
                    <button type="button" id="sendbtn" disabled="disabled">@Basis.Parse.Localization("transferring")</button>
                </td>
            </tr>
        </table>
    </nav>
    <script src="~/Scripts/mui.min/mui.min.js"></script>
    <script type="text/javascript">
        
        var pck = {
            sendid: "@Basis.Session.Uid",
            collid: "@(CollMember.id)",
            time: '2000-1-1',
            faceishide : true,
            connectionid: 0,
            connectionkey: "@(mtopt.rte.Encrypt.MD5.Encrypt("p2p" + Basis.Session.CKEY + DateTime.Now.Ticks.ToString()))",
            time: 0,
            imgbig: function (elm) {
                $(".big-img").show();
                $(".big-img").height($(window).height());
                $(".big-img img").attr("src", elm.src.replace("reduce=", "_reduce="));
            },
            upView: function (html) {
                $('.message').append(html);
                setTimeout(function () {
                    pck.scroll.reLayout();
                    pck.scroll.scrollToBottom(0);
                }, 199);
            },
            analyze: function (str) {
                str = str.replace(/{FS}/g, "<img class='face-img' src='/Images/Chat/i_f");
                str = str.replace(/{FE}/g, ".gif' />");
                return str;
            },
            send: function (headSrc, str, time) {
                var stime = new Date(time).getTime();
                var etime = new Date(pck.time).getTime();
                var dates = Math.abs((stime - etime)) / (1000 * 60);
                if (dates >= 5) {
                    var html = "<div class='send'><div class='time'>" + mDate(time).toFormatString("mm/dd hh:MM:ss") + "</div><div class='msg'><img src=" + headSrc + " />" + "<p><i class='msg_input'></i>" + pck.analyze(str) + "</p></div></div>";
                    pck.time = time;
                }
                else {
                    var html = "<div class='send'><div class='msg'><img src=" + headSrc + " />" + "<p><i class='msg_input'></i>" + pck.analyze(str) + "</p></div></div>";
                }
                this.upView(html);
            }
            ,
            show: function (headSrc, str, time) {
                var stime = new Date(time).getTime();
                var etime = new Date(pck.time).getTime();
                var dates = Math.abs((stime - etime)) / (1000 * 60);
                if (dates >= 5) {
                    var html = "<div class='show'><div class='time'>" + mDate(time).toFormatString("mm/dd hh:MM:ss") + "</div><div class='msg'><img src=" + headSrc + " />" + "<p><i class='msg_input'></i>" + pck.analyze(str) + "</p></div></div>";
                    pck.time = time;
                }
                else {
                    var html = "<div class='show'><div class='msg'><img src=" + headSrc + " />" + "<p><i class='msg_input'></i>" + pck.analyze(str) + "</p></div></div>";
                }
                this.upView(html);
            },
            face: function (id) {
                var content = $('#sendtext').val();
                content += "{FS}" + id + "{FE}";
                $('#sendtext').val(content);
                $('#sendbtn').css('background', '#ffaa00').removeAttr("disabled");
                this.hideface();
            },
            showface: function (id) {
                if (this.faceishide == true) {
                    $(".face-block").show();
                    this.faceishide = false;
                }
                else {
                    this.hideface();
                }
            },
            hideface: function (id) {
                $(".face-block").hide();
                this.faceishide = true;
            },
            click: function () {
                if ($('#sendtext').val().length > 0) {
                    pck.show("/images/def/userhead.jpg", $('#sendtext').val(), mDate().toFormatString("yyyy/mm/dd hh:MM:ss"));
                    //发送服务器请求
                    $.ajax({
                        url: '@Href("~/Shared/api_chat_submit")',
                        data: {
                            head:1,
                            collid: pck.collid,
                            content: $('#sendtext').val()
                        },
                        type: 'post',
                        cache: false,
                        dataType: 'json',
                        success: function (data) { },
                        error: function () { }
                    });
                    $('#sendtext').val("");
                }
            },
            inputopen: function (id) {
                $(id).click();
            },
            previewImage: function (file) {
                var div = document.getElementById(file.id + '_pre');
                lrz(file.files[0], { width: 1000 }).then(function (rst) {
                    rst.formData.append('base64img', rst.base64);
                    var img = document.getElementById(file.id + '_img');
                    //提取数据
                    var base64 = rst.base64;
                    pck.show("/images/def/userhead.jpg", "<img onclick='pck.imgbig(this)' src='" + base64 + "' />", mDate().toFormatString("yyyy/mm/dd hh:MM:ss"));
                    $.ajax({
                        url: '@Href("~/Shared/api_chat_submit")',
                        data: {
                            head: 2,
                            collid: pck.collid,
                            content: base64
                        },
                        type: 'post',
                        cache: false,
                        dataType: 'json',
                        success: function (data) { },
                        error: function () { }
                    });
                }).catch(function (err) {
                    engine.news("@Basis.Parse.Localization("failed_system")", 3000);
                }).always(function () { })
            },
            init: function () {
                pck.scroll = mui('#wrapper').scroll();
                $('#footer').on('keyup', 'input', function (e) {
                    if ($(this).val().length > 0) {
                        $('#sendbtn').css('background', '#ffaa00').removeAttr("disabled");
                        if (e.keyCode == 13) {
                            pck.click();
                        }

                    } else {
                        $('#sendbtn').css('background', '#ddd').attr({ "disabled": "disabled" });
                    }
                })
                $('#sendbtn').click(function () { pck.click(); })
                //注册服务器推送
                if (typeof (EventSource) !== "undefined") {
                    var source = new EventSource("/service/serversent.ashx?type=2&connectionkey=" + pck.connectionkey + "&sendid=" + pck.collid);
                    source.onmessage = function (event) {
                        if (event.data == null || event.data == "") {
                            return;
                        }
                        var datas = m.json.getObject(event.data);
                        var fisrt = pck.connectionid;
                        for (var i in datas) {
                            var content = datas[i].content;
                            if (datas[i].head == 2)
                            {
                                content = '<img onclick="pck.imgbig(this)" src="/Service/cms.ashx?head=2&id=' + datas[i].id + '&reduce=300" />';
                            }
                            if (datas[i].id > pck.connectionid) {
                                if (datas[i].sendId == pck.sendid) {
                                    if (fisrt <= 0) {
                                        pck.show("/images/def/userhead.jpg", content, datas[i].date);
                                    }
                                }
                                else {
                                    pck.send("/images/def/userhead.jpg", content, datas[i].date);
                                }
                                pck.connectionid = datas[i].id;
                            }
                        }
                    };
                }
            }
        }
        pck.init();
    </script>
</body>
</html>