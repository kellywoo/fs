@using mtopt.logic;
@using mtopt.model.EntitySales;
@using mtopt.rte.Encrypt;
@{
    ViewBag.Title = Basis.Parse.Localization("user_find_pw");
    Layout = "~/Views/Shared/mst_main.cshtml";

}
@section head{
    <style type="text/css">
        .login-register{background:url(/images/login-bg.jpg) no-repeat center;background-size:cover;height:750px}
        .form-login-register{width:440px;margin-left:auto;margin-right:auto;margin-top:118px;height:524px;background:#fff;box-shadow:0 0 15px #ccc;padding:45px 45px 20px 45px}
        .form-login-register h1{color:#e9504a;margin:0 0 45px 0}
        .form-login-register .form-control,.form-login-register .form-control:focus{border:none;box-shadow:none;border-bottom:1px solid #d1d1d1;border-radius:0;height:45px}
        .form-login-register p{font-size:12px;color:#999;margin-top:20px;margin-bottom:15px}
        .form-login-register p a{color:#e9504a}
        .form-login-register.register,.form-login-register.reset-password{height:555px;margin-top:37px}
        .form-login-register #sendSms{top:7px;right:0}
        .form-login-register.reset-password button[type=submit]{margin-top:55px}
    </style>
}
<div class="login-register">
    <div class="mn-container">
        <div class="row">
            <div class="col-xs-12">
                <form class="form-login-register login">
                    <h1 class="center">@Basis.Parse.Localization("user_find_pw")</h1>
                    <div class="form-group">
                        <input type="text" id="memberid" class="form-control" placeholder="@Basis.Parse.Localization("user_id")">
                    </div>
                    <div class="form-group">
                        <input type="password" id="password" class="form-control" placeholder="@Basis.Parse.Localization("user_enter_new_pw")">
                    </div>
                    <div class="form-group">
                        <input type="password" id="cpassword" class="form-control" placeholder="@Basis.Parse.Localization("user_enter_new_pwc")">
                    </div>
                    <div class="form-group row" style="margin-bottom:50px">
                        <div class="col-xs-7">
                            <input id="checkcode" type="text" class="form-control" placeholder="@Basis.Parse.Localization("com_vcode")" required="required" />
                        </div>
                        <div class="col-xs-5">
                            <input id="btn_sendcc" type="button" class="btn btn-orange btn-lg" value="@Basis.Parse.Localization("com_vcode_send")" style="width:100%;" />
                        </div>
                    </div>

                    <a class="btn btn-orange btn-block btn-lg" id="btn_enter">@Basis.Parse.Localization("user_find_pw")</a>
                    <p class="center">
                        <a href="~/User/register">@Basis.Parse.Localization("user_signup")</a> | <a href="/User/login">@Basis.Parse.Localization("com_to_login")</a>
                    </p>
                </form>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var pck = {
        menuid: "user",
        init: function () {
            m.node(".mn-menu-home").addClass("active");
        }
    }
    pck.init();
    /*******************绑定发送按钮********************/
    m.node("#btn_sendcc").click(function () {
        var memberid = m.node("#memberid").value();
        if (memberid.length <= 0) {
            engine.news("@Basis.Parse.Localization("user_enter_cell_num")", 2000);
            return;
        }
        engine.news("@Basis.Parse.Localization("com_vcode_processing")", 999, 6);
        var jso = m.post("@Href("~/User/fixedsend?memberid=")" + memberid, null);
        jso = m.json.getObject(jso);
        //判断返回值
        switch (m.parse.toInteger(jso.Error)) {
            case 0:
                var btn = m.node("#btn_sendcc").first();
                mSpace().cctime = 60;
                //设置计时器
                var itl = setInterval(function () {
                    var sec = mSpace().cctime;
                    if (sec > 0) {
                        sec -= 1;
                        btn.disabled = true;
                        btn.value = "@Basis.Parse.Localization("com_wait")" + sec + "@Basis.Parse.Localization("com_seconds")";
                    }
                    else {
                        btn.disabled = false;
                        btn.value = "@Basis.Parse.Localization("com_vcode_request")";
                        clearInterval(itl);
                    }
                    mSpace().cctime = sec;
                }, 1000);
                engine.news("@Basis.Parse.Localization("com_complete_sending")", 3000);
                break;
            case -10001:
                engine.news("@Basis.Parse.Localization("com_vcode_limited_time")", 3000);
                break;
            default:
                engine.news("@Basis.Parse.Localization("com_failed")", 3000);
                break;
        }
    });
    m.node("#btn_enter").click(function () {
        var memberid = m.node("#memberid").value();
        var password = m.node("#password").value();
        var cpassword = m.node("#cpassword").value();
        var checkcode = m.node("#checkcode").value();
        if (memberid.length <= 0) {
            engine.news("@Basis.Parse.Localization("user_enter_cell_num")", 2000);
            return;
        }
        if (password.length <= 0) {
            engine.news("@Basis.Parse.Localization("user_enter_new_pw")", 2000);
            return;
        }
        if (password != cpassword) {
            engine.news("@Basis.Parse.Localization("user_pw_different")", 2000);
            return;
        }
        if (checkcode.length <= 0) {
            engine.news("@Basis.Parse.Localization("com_vcode_enter")", 2000);
            return;
        }
        engine.news("@Basis.Parse.Localization("user_change_pw")", 99999, 6);
        var ajax = m.ajax("@Href("~/User/api_find_submit")", null, function (obj) {
            var jso = m.json.getObject(obj);
            if (jso.Success == true) {
                engine.news("@Basis.Parse.Localization("welcome_login")", 99999, 6);
                m.redirect("@Href("~/User/login")");
            }
            else {
                if (jso.Error == -10003) {
                    engine.news("@Basis.Parse.Localization("com_vcode_wrong")", 2000);
                }
                else if (jso.Error == -10001) {
                    engine.news("@Basis.Parse.Localization("user_no_id_or_pw")", 2000);
                }
                else {
                    engine.news(jso.Data, 2000);
                }
            }
        });
        ajax.data.add("memberid", memberid);
        ajax.data.add("password", password);
        ajax.data.add("checkcode", checkcode);
        ajax.send();
    });
</script>