@using mtopt.logic;
@using mtopt.model;
@using mtopt.model.EntitySales;
@{
    ViewBag.Title = Basis.Parse.Localization("key23");
    Layout = "~/Views/Shared/mst_main.cshtml";
    //提取数据
    stockmarket_account Account = ViewBag.Account != null ? ViewBag.Account : null;
    stockmarket_type StockmarketType = ViewBag.StockmarketType;
}
@section head{
    <style type="text/css">
        #type_info .title{color:#888;height:18px;}
        #type_info .value{height:20px;}
        #menu_panel {border:1px solid #ddd;}
        #menu_panel .btn{border-bottom-left-radius:0px;border-bottom-right-radius:0px;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom:0px none;border-left:0px none;border-top:0px;}
        #menu_panel .btn-active{background-color:#e9504a;color:#fff;}
        #sell_panel,#buy_panel,#list_panel{min-height:400px;border-top:0px none;border-top-left-radius:0px;border-top-right-radius:0px;}
        .input-table{width:96%;margin:0 2%}
        .input-table tr td{height:60px}
        .input-table .title{width:35%;font-weight:400}
    </style>
}
<div class="mn-container">
    <table id="type_info" class="panel panel-default" style="width:100%;margin-top:1.5em;height:65px;">
        <tr>
            <td style="width:60px;text-align:center;">
                <img src="@(StockmarketType.icon)" style="width:46px;">
            </td>
            <td style="width:200px;">
                <h4 style="font-weight:600">@(Basis.Parse.ToLanguage(StockmarketType.name))(@(StockmarketType.code))</h4>
            </td>
            <td style="width:300px;">

            </td>
            <td style="width:120px;">
                <div class="title">@Basis.Parse.Localization("key24")</div>
                <div id="newprice" class="value">@(StockmarketType.today_price_new)</div>
            </td>
            <td style="width:120px;">
                <div class="title">@Basis.Parse.Localization("key25")</div>
                <div id="maxprice" class="value">@(StockmarketType.today_price_max)</div>
            </td>
            <td style="width:120px;">
                <div class="title">@Basis.Parse.Localization("key26")</div>
                <div id="minprice" class="value">@(StockmarketType.today_price_min)</div>
            </td>
            <td style="width:120px;">
                <div class="title">@Basis.Parse.Localization("key27")</div>
                <div id="amountprice" class="value">@(StockmarketType.today_deal_amount)</div>
            </td>
        </tr>
    </table>
    <table style="margin-top:1.5em;width:100%;">
        <tr>
            <td valign="top" style="width:72%;padding-right:15px;">
                <div class="panel panel-default" style="padding:5px;">
                    <iframe src="~/Stock/kline?symbol=@(StockmarketType.id)&themename=Light" style="width:100%;height:427px;" frameborder="0"></iframe>
                </div>
            </td>
            <td valign="top" style="width:28%;">
                <div id="menu_panel" class="btn-group btn-group-justified">
                    <a onclick="pck.showbuy(this)" class="btn btn-default btn-active">@Basis.Parse.Localization("com_sell")</a>
                    <a onclick="pck.showsell(this)" class="btn btn-default">@Basis.Parse.Localization("com_buy")</a>
                    <a onclick="pck.showlist(this)" class="btn btn-default" style="border-right:0px none">@Basis.Parse.Localization("com_bid")</a>
                </div>
                <div id="buy_panel" class="panel panel-default">
                    <div class="panel-body">
                        <table class="input-table">
                            <tr>
                                <td class="title">@Basis.Parse.Localization("key28")</td>
                                <td><input type="number" class="form-control" onkeyup="pck.buy_total()" id="buy_price" placeholder="@Basis.Parse.Localization("key29")" value="@Business.StockMarketTrend.GetBuyPrice(StockmarketType.id)"></td>
                            </tr>
                            <tr>
                                <td class="title">@Basis.Parse.Localization("trade_amount")</td>
                                <td><input type="number" class="form-control" onkeyup="pck.buy_total()" id="buy_amount" placeholder="@Basis.Parse.Localization("key30")"></td>
                            </tr>
                            <tr>
                                <td class="title">@Basis.Parse.Localization("key31")</td>
                                <td>
                                    <input id="buyselect" type="text" data-slider-min="0" data-slider-max="@(Account != null ? (Account.member.money / Business.StockMarketTrend.GetBuyPrice(StockmarketType.id)) : 0)" data-slider-step="0.00001" data-slider-value="0" />
                                </td>
                            </tr>
                            <tr>
                                <td class="title">@Basis.Parse.Localization("key32")</td>
                                <td><input type="number" class="form-control" id="buy_money" onkeyup="pck.buy_sub(this)" value="0.00"></td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    @if (Account != null)
                                    {
                                        <button type="button" onclick="pck.buy()" class="btn btn-orange btn-block">@Basis.Parse.Localization("key33")</button>
                                    }
                                        else
                                        {
                                        <a href="~/User/login" class="btn btn-orange btn-block">@Basis.Parse.Localization("key33")</a>
                                    }
                                </td>
                            </tr>
                        </table>
                        <a id="member_money" style="margin-left:0.5em;">@Basis.Parse.Localization("key34")：<span>@(Account != null ? Account.member.money : 0)</span></a>
                    </div>
                </div>
                <div id="sell_panel" class="panel panel-default" style="display:none">
                    <div class="panel-body">
                        <table class="input-table">
                            <tr>
                                <td class="title">@Basis.Parse.Localization("key35")</td>
                                <td><input type="number" class="form-control" onkeyup="pck.sell_total()" id="sell_price" placeholder="@Basis.Parse.Localization("key29")" value="@Business.StockMarketTrend.GetSellPrice(StockmarketType.id)"></td>
                            </tr>
                            <tr>
                                <td class="title">@Basis.Parse.Localization("amount_to_sell")</td>
                                <td><input type="number" class="form-control" onkeyup="pck.sell_total()" id="sell_amount" placeholder="@Basis.Parse.Localization("key30")"></td>
                            </tr>
                            <tr>
                                <td class="title">@Basis.Parse.Localization("key31")</td>
                                <td>
                                    <input id="sellselect" type="text" data-slider-min="0" data-slider-max="@(Account != null ? Account.money : 0)" data-slider-step="0.00001" data-slider-value="14" />
                                </td>
                            </tr>
                            <tr>
                                <td class="title">@Basis.Parse.Localization("key32")</td>
                                <td><input type="number" class="form-control" id="sell_money"onkeyup="pck.sell_sub()" value="0.00"></td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    @if (Account != null)
                                    {
                                        <button type="button" onclick="pck.sell()" class="btn btn-orange btn-block">@Basis.Parse.Localization("stock_confirm_sold")</button>
                                    }
                                        else
                                        {
                                        <a href="~/User/login" class="btn btn-orange btn-block">@Basis.Parse.Localization("stock_confirm_sold")</a>
                                    }
                                </td>
                            </tr>
                        </table>
                        <a id="account_money" style="margin-left:0.5em;">@Basis.Parse.Localization("key36")：<span>@(Account != null ? Account.money : 0)</span></a>
                    </div>
                </div>
                <div id="list_panel" class="panel panel-default" style="display:none;overflow-y:scroll;height:400px;">
                    <table id="mysentrusts" class="table table-striped table-hover center">
                        <thead class="mtablehead">
                            <tr>
                                <td>@Basis.Parse.Localization("com_sell_buy")</td>
                                <td>@Basis.Parse.Localization("key37")</td>
                                <td>@Basis.Parse.Localization("key38")</td>
                                <td>@Basis.Parse.Localization("com_dealing")</td>
                            </tr>
                        </thead>
                        <tbody class="record-list"></tbody>
                    </table>
                </div>
            </td>
        </tr>
    </table>
    <table style="margin-top:0.3em;width:100%;">
        <tr>
            <td valign="top" style="width:36%;padding-right:15px;">
                <table id="allentrusts_buy" class="table table-striped table-hover center panel panel-default">
                    <thead class="mtablehead">
                        <tr>
                            <td>@Basis.Parse.Localization("selling")</td>
                            <td>@Basis.Parse.Localization("key37")</td>
                            <td>@Basis.Parse.Localization("key38")</td>
                        </tr>
                    </thead>
                    <tbody class="record-list"></tbody>
                </table>
            </td>
            <td valign="top" style="width:36%;padding-right:15px;">
                <table id="allentrusts_sell" class="table table-striped table-hover center panel panel-default">
                    <thead class="mtablehead">
                        <tr>
                            <td>@Basis.Parse.Localization("buying")</td>
                            <td>@Basis.Parse.Localization("key37")</td>
                            <td>@Basis.Parse.Localization("key38")</td>
                        </tr>
                    </thead>
                    <tbody class="record-list"></tbody>
                </table>
            </td>
            <td valign="top" style="width:28%;">
                <table id="allentrusts_turnover" class="table table-striped table-hover center panel panel-default">
                    <thead class="mtablehead">
                        <tr>
                            <td>@Basis.Parse.Localization("key39")</td>
                            <td>@Basis.Parse.Localization("key40")</td>
                            <td>@Basis.Parse.Localization("key41")</td>
                        </tr>
                    </thead>
                    <tbody class="record-list"></tbody>
                </table>
            </td>
        </tr>
    </table>
</div>
<input type="hidden" id="auto_update" />
<script type="text/javascript">
    //获取数据
    var pck = {
        showbuy: function (elm) {
            m.node("a", elm.parentNode).removeClass("btn-active");
            m.node(elm).addClass("btn-active");
            m.node("#sell_panel").hide();
            m.node("#deal_panel").show();
            m.node("#list_panel").hide();
            m.node("#buy_panel").show();
        },
        showsell: function (elm) {
            m.node("a", elm.parentNode).removeClass("btn-active");
            m.node(elm).addClass("btn-active");
            m.node("#sell_panel").show();
            m.node("#deal_panel").show();
            m.node("#list_panel").hide();
            m.node("#buy_panel").hide();
        },
        showlist: function (elm) {
            m.node("a", elm.parentNode).removeClass("btn-active");
            m.node(elm).addClass("btn-active");
            m.node("#deal_panel").hide();
            m.node("#sell_panel").hide();
            m.node("#list_panel").show();
            m.node("#buy_panel").hide();
        },
        buy_sub : function(elm){
            m.node("#buy_amount").value(Math.floor(elm.value / m.node("#buy_price").value() * 10000) / 10000);
        },
        buy_total: function () {
            var buy_price = m.node("#buy_price").value();
            var buy_amount = m.node("#buy_amount").value();
            buy_price = buy_price || 0;
            buy_amount = buy_amount || 0;
            m.node("#buy_money").value(Math.floor(buy_price * buy_amount * 10000) / 10000);
        },
        sell_total: function () {
            var sell_price = m.node("#sell_price").value();
            var sell_amount = m.node("#sell_amount").value();
            sell_price = sell_price || 0;
            sell_amount = sell_amount || 0;
            m.node("#sell_money").value(Math.floor(sell_price * sell_amount * 10000) / 10000);
        },
        sell_sub : function(elm){
            m.node("#sell_amount").value(Math.floor(elm.value / m.node("#sell_price").value() * 10000) / 10000);
        },
        cancel:function(id,type){
            engine.confirm("@Basis.Parse.Localization("key42")", "@Basis.Parse.Localization("key42")" + id, function () {
                //发送请求
                var ajax = m.ajax("@Href("~/Stock/api_main_cancel")", null, function (jso) {
                    var jso = m.json.getObject(jso);
                    switch (jso.Error) {
                        case 0:
                            engine.news("@Basis.Parse.Localization("complete_cancellation")", 2000);
                            break;
                        case -10000:
                            engine.news("@Basis.Parse.Localization("failed_cancellation")", 2000);
                            break;
                        default:
                            engine.news(jso.Data, 2000);
                            break;
                    }
                });
                ajax.data.add("accountid", @(Account == null ? "null" : Account.id.ToString()));
                ajax.data.add("id", id);
                ajax.data.add("type", type);
                ajax.send();
            });
        },
        buy: function () {
            var price = m.node("#buy_price").value();
            var amount = m.node("#buy_amount").value();
            if (price.length <= 0) {
                engine.news("@Basis.Parse.Localization("enter_the_price")", 1800);
                return;
            }
            if (amount.length <= 0) {
                engine.news("@Basis.Parse.Localization("enter_the_amount")", 1800);
                return;
            }
            engine.confirm("@Basis.Parse.Localization("buying_detail_confirmation")", "@Basis.Parse.Localization("unit_price")" + price + "@Basis.Parse.Localization("com_sell")" + amount + "@Basis.Parse.Localization("counting_unit")", function () {
                //发送请求
                var ajax = m.ajax("@Href("~/Stock/api_main_buy")", null, function (jso) {
                    var jso = m.json.getObject(jso);
                    switch (jso.Error) {
                        case 0:
                            engine.news("@Basis.Parse.Localization("complete_selling")", 2000);
                            break;
                        case -10000:
                            engine.news("@Basis.Parse.Localization("failed_selling")", 2000);
                            break;
                        default:
                            engine.news(jso.Data, 2000);
                            break;
                    }
                });
                ajax.data.add("accountid", @(Account == null ? "null" : Account.id.ToString()));
                ajax.data.add("amount", amount);
                ajax.data.add("price", price);
                ajax.send();
            });
        },
        sell: function () {
            var price = m.node("#sell_price").value();
            var amount = m.node("#sell_amount").value();
            if (price.length <= 0) {
                engine.news("@Basis.Parse.Localization("enter_the_price")", 1800);
                return;
            }
            if (amount.length <= 0) {
                engine.news("@Basis.Parse.Localization("enter_the_amount")", 1800);
                return;
            }
            engine.confirm("@Basis.Parse.Localization("selling_detail_confirmation")", "@Basis.Parse.Localization("unit_price")" + price + "@Basis.Parse.Localization("com_buy")" + amount + "@Basis.Parse.Localization("counting_unit")", function () {
                //发送请求
                var ajax = m.ajax("@Href("~/Stock/api_main_sell")", null, function (jso) {
                    var jso = m.json.getObject(jso);
                    switch (jso.Error) {
                        case 0:
                            engine.news("@Basis.Parse.Localization("complete_buying")", 2000);
                            break;
                        case -10000:
                            engine.news("@Basis.Parse.Localization("failed_buying")", 2000);
                            break;
                        default:
                            engine.news(jso.Data, 2000);
                            break;
                    }
                });
                ajax.data.add("accountid", @(Account == null ? "null" : Account.id.ToString()));
                ajax.data.add("amount", amount);
                ajax.data.add("price", price);
                ajax.send();
            });
        },
        refurbish:function(){
            var ajax = m.ajax("@Href("~/Stock/get_main_entrusts")", null, function (jso) {
                var data = m.json.getObject(jso);
                //所有委托开始
                if(data.AllEntrusts != null){
                    var si = 1;
                    var bi = 1;
                    var buyhtml = "";
                    var turnoverhtml = "";
                    var sellhtml = "";
                    if(data.Money) {
                        m.node("#member_money span").html(data.Money);
                        m.node("#account_money span").html(data.Account);
                    }
                    m.node("#newprice").html(data.NewPrice);
                    if(data.RisePrice >=0){
                        m.node("#newprice").removeClass("green").addClass("red");
                    }
                    else{
                        m.node("#newprice").removeClass("red").addClass("green");
                    }
                    m.node("#maxprice").html(data.MaxPrice);
                    m.node("#minprice").html(data.MinPrice);
                    m.node("#amountprice").html(data.AmountPrice);
                    m.node("#allentrusts_buy tbody").html("");
                    m.node("#allentrusts_sell tbody").html("");
                    m.node("#allentrusts_turnover tbody").html("");
                    for(var i in data.AllEntrusts)
                    {
                        var AllEntrust = data.AllEntrusts[i];
                        if(AllEntrust.type == 1)
                        {
                            buyhtml += "<tr><td><span class='btn btn-xs btn-orange'>@Basis.Parse.Localization("selling")"+bi+"</span></td><td>"+AllEntrust.price+"</td><td>"+AllEntrust.amount+"</td></tr>";
                            bi++;

                        }
                        else if (AllEntrust.type == 2){
                            sellhtml += "<tr><td><span class='btn btn-xs btn-success'>@Basis.Parse.Localization("buying")"+si+"</span></td><td>"+AllEntrust.price+"</td><td>"+AllEntrust.amount+"</td></tr>";
                            si++;
                        }
                        else{
                            turnoverhtml += "<tr><td>"+AllEntrust.date+"</td><td>"+AllEntrust.price+"</td><td>"+AllEntrust.amount+"</td></tr>";
                        }
                    }
                    m.node("#allentrusts_sell tbody").html(sellhtml);
                    m.node("#allentrusts_buy tbody").html(buyhtml);
                    m.node("#allentrusts_turnover tbody").html(turnoverhtml);
                }
                if(data.MysEntrusts != null){
                    var content = "";
                    m.node("#mysentrusts tbody").html("");
                    for(var i in data.MysEntrusts)
                    {
                        var MysEntrust = data.MysEntrusts[i];
                        var html = "<tr><td>";
                        if(MysEntrust.type == 1)
                        {
                            html += "<span class='btn btn-xs btn-orange'>@Basis.Parse.Localization("selling")"+MysEntrust.id+"</span>";
                        }
                        else{
                            html += "<span class='btn btn-xs btn-success'>@Basis.Parse.Localization("buying")"+MysEntrust.id+"</span>";
                        }
                        html+="</td><td>"+MysEntrust.price+"</td><td>"+MysEntrust.amount+"</td>";
                        html+="<td><a class='btn btn-xs btn-danger' onclick='pck.cancel("+MysEntrust.id+", "+MysEntrust.type+")'>@Basis.Parse.Localization("cancel_order")</a></td></tr>";
                        content += html;
                    }
                    m.node("#mysentrusts tbody").html(content);
                }
            });
            ajax.data.add("accountid", @(Account == null ? "null" : Account.id.ToString()));
            ajax.data.add("type", @(StockmarketType.id));
            ajax.send();
        },
        init: function () {
            m.node(".mn-menu-stockmain").addClass("active");
            pck.refurbish();
            setInterval(function(){ pck.refurbish() },3000);
            document.bselm = new Slider('#buyselect', {formatter: function(value) { pck.buy_total(); m.node("#buy_amount").value(value); return '@Basis.Parse.Localization("possessed_amount"): ' + value; } });
            document.sselm = new Slider('#sellselect', { formatter: function(value) { pck.sell_total(); m.node("#sell_amount").value(value); return '@Basis.Parse.Localization("possessed_amount")' + value; } });
        }
    }
    pck.init();
</script>
